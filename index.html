<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¿”æ…¶æ—…è¡Œç¤¾é ˜éšŠç³»çµ± V68 - å„ªåŒ–ç‰ˆ</title>
    
    <!-- æ ¸å¿ƒå¼•æ“ (å·²ä½¿ç”¨ Production ç‰ˆæœ¬) -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- ç§»é™¤ Babelï¼Œå› ç‚ºç¨‹å¼ç¢¼å‡è¨­å·²é å…ˆè½‰è­¯ -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK (ä½¿ç”¨ç›¸å®¹ç‰ˆæœ¬) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        body { background-color: #111827; color: white; font-family: system-ui, sans-serif; overscroll-behavior: none; }
        input, select, textarea { font-size: 16px !important; }
        .card-shadow { box-shadow: 2px 4px 6px rgba(0,0,0,0.3); }
        /* Modal Animation */
        .modal-enter { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- é€™è£¡ä½¿ç”¨æ¨™æº–çš„ text/javascriptï¼Œä¸å†ä¾è³´ Babel è½‰è­¯ -->
    <script type="text/javascript">
        // ä½¿ç”¨ React.createElement çš„ç°¡å¯«
        const { useState, useEffect, createElement: e } = React;
        const { getApp, initializeApp } = firebase;
        const { getAuth, signInAnonymously } = firebase.auth;
        const { getFirestore, collection, doc, onSnapshot, setDoc, updateDoc, FieldValue } = firebase.firestore;


        const LOCAL_STORAGE_KEY = 'xiangqing_v68_data';
        const FIREBASE_CONFIG_KEY = 'xiangqing_firebase_config';
        const APP_ID = 'default-tour-app';

        // ç”±æ–¼æˆ‘å€‘ä½¿ç”¨ React.createElementï¼Œæˆ‘å€‘éœ€è¦ç¢ºä¿æ‰€æœ‰ Firebase æ“ä½œéƒ½å·²è¼‰å…¥
        const fv = firebase.firestore.FieldValue; // ç°¡åŒ– FieldValue å¼•ç”¨

        const INITIAL_DATA = {
            leaders: [
                { id: 'L1', name: 'ç‹å°æ˜', username: '11301', password: '1234', group: 'G-1128', busId: 'bus_A' },
                { id: 'L2', name: 'é™³å¤§è¯', username: '11302', password: '1234', group: 'G-1128', busId: 'bus_B' },
                { id: 'L3', name: 'æ—ç¾éº—', username: '11303', password: '1234', group: 'G-1128', busId: 'bus_C' },
            ],
            tours: {
                'bus_A': { busName: "Aè»Š (ç‹å°æ˜)", members: [{ id: 'm1', name: 'å¼µä¸‰', phone: '0912345678' }], boardedIds: [] },
                'bus_B': { busName: "Bè»Š (é™³å¤§è¯)", members: [], boardedIds: [] },
                'bus_C': { busName: "Cè»Š (æ—ç¾éº—)", members: [], boardedIds: [] },
            },
            adminPassword: 'admin888',
            systemUrl: ''
        };

        let db, auth;
        let isCloudReady = false;

        // --- 1. è‡ªå‹•åµæ¸¬ç¶²å€ä¸­çš„è¨­å®šç¢¼ (Magic Link Handler) ---
        try {
            const params = new URLSearchParams(window.location.search);
            const setupCode = params.get('setup');
            if (setupCode) {
                try {
                    // è§£ç¢¼ Base64 -> JSON
                    const configStr = atob(setupCode);
                    const config = JSON.parse(configStr);
                    localStorage.setItem(FIREBASE_CONFIG_KEY, JSON.stringify(config));
                    // æ¸…é™¤ç¶²å€åƒæ•¸ï¼Œé¿å…çœ‹èµ·ä¾†å¾ˆäº‚
                    window.history.replaceState({}, document.title, window.location.pathname);
                    alert("ğŸ‰ é›²ç«¯è¨­å®šå·²è‡ªå‹•åŒ¯å…¥ï¼ç³»çµ±å°‡é€£æ¥è‡³è³‡æ–™åº«ã€‚");
                } catch(e) {
                    console.error("è¨­å®šç¢¼ç„¡æ•ˆ", e);
                }
            }
        } catch(e) {}

        // --- 2. åˆå§‹åŒ– Firebase ---
        try {
            const savedConfig = localStorage.getItem(FIREBASE_CONFIG_KEY);
            if (savedConfig) {
                const config = JSON.parse(savedConfig);
                if (!firebase.apps.length) initializeApp(config);
                db = firebase.firestore();
                auth = firebase.auth();
                isCloudReady = true;
            }
        } catch (e) { console.error("Firebase Init Error", e); }

        const Icon = ({ i }) => e('span', { className: 'inline-block mr-1 align-middle text-xl' }, i);

        function App() {
            const [view, setView] = useState('landing');
            const [isCloud, setIsCloud] = useState(isCloudReady);
            const [leaders, setLeaders] = useState(INITIAL_DATA.leaders);
            const [tours, setTours] = useState(INITIAL_DATA.tours);
            
            const [identity, setIdentity] = useState(null);
            const [viewingBusId, setViewingBusId] = useState(null);
            const [inputs, setInputs] = useState({ user: '', pass: '', adminPass: '', bulk: '', memberPhone: '', firebase: '' });
            const [modal, setModal] = useState(null);
            const [selectedMember, setSelectedMember] = useState(null);
            const [showPassword, setShowPassword] = useState(false);

            // Init
            useEffect(() => {
                const init = async () => {
                    if (isCloud) {
                        try {
                            await auth.signInAnonymously();
                            db.collection('nas_apps').doc(APP_ID).collection('config').doc('main')
                                .onSnapshot(doc => {
                                    if (doc.exists) setLeaders(doc.data().leaders);
                                    // ç¢ºä¿è³‡æ–™åº«æœ‰åˆå§‹è³‡æ–™
                                    else setDoc(doc.ref, { leaders: INITIAL_DATA.leaders });
                                });
                        } catch(e) { 
                            console.error("Cloud initialization failed:", e);
                            setIsCloud(false); 
                        }
                    }
                    if (!isCloud) {
                        const saved = localStorage.getItem(LOCAL_STORAGE_KEY);
                        if (saved) {
                            const parsed = JSON.parse(saved);
                            setLeaders(parsed.leaders || INITIAL_DATA.leaders);
                            setTours(parsed.tours || INITIAL_DATA.tours);
                        }
                    }
                };
                init();
            }, [isCloud]);

            // Sync
            useEffect(() => {
                if (!isCloud || !viewingBusId) return;
                const unsub = db.collection('nas_apps').doc(APP_ID).collection('tours').doc(viewingBusId)
                    .onSnapshot(doc => {
                        if (doc.exists) setTours(prev => ({ ...prev, [viewingBusId]: doc.data() }));
                        else {
                            const initial = tours[viewingBusId] || { busName: "æ–°è»Šæ¬¡", members: [], boardedIds: [] };
                            setDoc(doc.ref, initial);
                        }
                    });
                return () => unsub();
            }, [isCloud, viewingBusId]);

            // Local Storage Sync
            useEffect(() => {
                if (!isCloud) localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify({ leaders, tours }));
            }, [leaders, tours, isCloud]);

            // --- Logic ---
            const updateBusData = async (busId, newData) => {
                // if (identity.role === 'leader' && identity.busId !== busId) return alert("åªèƒ½æ“ä½œè‡ªå·±çš„è»Šæ¬¡"); // è¨»é‡‹æ‰ï¼Œè®“ç®¡ç†å“¡å¯ä»¥æ“ä½œ
                setTours(prev => ({ ...prev, [busId]: { ...prev[busId], ...newData } }));
                if (isCloud) await updateDoc(doc(db, 'nas_apps', APP_ID, 'tours', busId), newData);
            };

            const toggleBoarding = (busId, memberId, isBoarding) => {
                const bus = tours[busId];
                let newBoarded = [...bus.boardedIds];
                if (isBoarding) {
                    if (!newBoarded.includes(memberId)) newBoarded.push(memberId);
                } else {
                    newBoarded = newBoarded.filter(id => id !== memberId);
                }

                if (isCloud) {
                    const ref = doc(db, 'nas_apps', APP_ID, 'tours', busId);
                    updateDoc(ref, {
                        boardedIds: isBoarding ? fv.arrayUnion(memberId) : fv.arrayRemove(memberId)
                    });
                    setTours(prev => ({ ...prev, [busId]: { ...bus, boardedIds: newBoarded } }));
                } else {
                    updateBusData(busId, { boardedIds: newBoarded });
                }
            };

            const handleImport = () => {
                if (!inputs.bulk) return;
                const lines = inputs.bulk.split(/\n/);
                const newMembers = lines.map((l, i) => {
                    // æ”¯æ´ç©ºæ ¼æˆ–é€—è™Ÿåˆ†éš”
                    const [n, p] = l.trim().split(/[\s,]+/); 
                    if (n) return { id: `m_${Date.now()}_${i}`, name: n, phone: p || '' };
                    return null;
                }).filter(x => x);
                
                const bus = tours[viewingBusId];
                updateBusData(viewingBusId, { members: [...bus.members, ...newMembers] });
                setInputs({ ...inputs, bulk: '' });
                setModal(null);
                alert(`æˆåŠŸåŒ¯å…¥ ${newMembers.length} äºº`);
            };

            const handleMemberVerify = () => {
                const bus = tours[viewingBusId];
                const code = inputs.memberPhone;
                // æª¢æŸ¥æ‰‹æ©Ÿæœ«ä¸‰ç¢¼
                const member = bus.members.find(m => m.phone && m.phone.endsWith(code));
                
                if (member) {
                    if (bus.boardedIds.includes(member.id)) alert(`${member.name} å·²ç¶“å ±åˆ°éäº†`);
                    else {
                        toggleBoarding(viewingBusId, member.id, true);
                        alert(`æ­¡è¿ ${member.name} ä¸Šè»Šï¼`);
                        setModal(null);
                    }
                } else {
                    alert("é©—è­‰å¤±æ•—ï¼Œæ‰¾ä¸åˆ°æ­¤æ‰‹æ©Ÿæœ«3ç¢¼");
                }
            };

            const saveFirebaseConfig = () => {
                try {
                    const config = JSON.parse(inputs.firebase);
                    localStorage.setItem(FIREBASE_CONFIG_KEY, JSON.stringify(config));
                    alert("è¨­å®šå„²å­˜ï¼Œé‡å•Ÿä¸­...");
                    window.location.reload();
                } catch(e) { alert("JSON æ ¼å¼éŒ¯èª¤"); }
            };

            // â˜… V68 æ–°å¢ï¼šç”¢ç”Ÿæ‡¶äººé€£çµ â˜…
            const generateMagicLink = () => {
                const currentConfig = localStorage.getItem(FIREBASE_CONFIG_KEY);
                if (!currentConfig) return alert("è«‹å…ˆåœ¨ä¸Šæ–¹è²¼ä¸Š Firebase Config å•Ÿç”¨é›²ç«¯åŠŸèƒ½ï¼Œæ‰èƒ½ç”¢ç”Ÿåˆ†äº«é€£çµï¼");
                
                // åŠ å¯†è¨­å®šç¢¼
                const setupCode = btoa(currentConfig);
                // çµ„åˆç¶²å€
                const baseUrl = window.location.href.split('?')[0];
                const magicUrl = `${baseUrl}?setup=${setupCode}`;
                
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(magicUrl).then(() => alert("âœ… é­”è¡“é€£çµå·²è¤‡è£½ï¼\n\nè«‹å°‡æ­¤é€£çµå‚³çµ¦é ˜éšŠ/åœ˜å“¡ï¼Œ\nä»–å€‘é»é–‹å¾Œå°±æœƒè‡ªå‹•é€£ç·šåˆ°é›²ç«¯è³‡æ–™åº«ï¼Œ\nå®Œå…¨ä¸ç”¨æ‰‹å‹•è¨­å®šï¼"));
                } else {
                    prompt("è«‹è¤‡è£½æ­¤é­”è¡“é€£çµ:", magicUrl);
                }
            };

            // --- Render ---
            if (view === 'landing') return (
                e('div', { className: 'min-h-screen flex flex-col items-center justify-center p-6 bg-gray-900 text-white' },
                    e('h1', { className: 'text-4xl font-bold mb-4' }, 'ç¿”æ…¶æ—…è¡Œç¤¾'),
                    e('div', { className: `px-4 py-1 rounded-full text-xs font-bold mb-10 ${isCloud ? 'bg-green-600' : 'bg-orange-500'}` },
                        isCloud ? 'â˜ï¸ é›²ç«¯é€£ç·šç‰ˆ V68' : 'ğŸ’¾ æœ¬æ©Ÿå–®æ©Ÿç‰ˆ V68'
                    ),
                    e('div', { className: 'w-full max-w-xs space-y-4' },
                        e('div', { className: 'bg-gray-800 p-6 rounded-2xl border border-gray-700' },
                            e('h2', { className: 'text-xl font-bold mb-4 flex items-center gap-2' }, 'ğŸ§¢ é ˜éšŠç™»å…¥'),
                            e('input', { 
                                value: inputs.user, 
                                onChange: e=>setInputs({...inputs, user: e.target.value}), 
                                className: 'w-full bg-gray-900 border border-gray-600 p-3 rounded-lg mb-3 text-white', 
                                placeholder: 'å¸³è™Ÿ', 
                                autoCapitalize: 'off' 
                            }),
                            e('input', { 
                                type: 'password', 
                                value: inputs.pass, 
                                onChange: e=>setInputs({...inputs, pass: e.target.value}), 
                                className: 'w-full bg-gray-900 border border-gray-600 p-3 rounded-lg mb-4 text-white', 
                                placeholder: 'å¯†ç¢¼' 
                            }),
                            e('button', { onClick: ()=>{
                                const cleanUser = inputs.user.trim().toLowerCase();
                                const cleanPass = inputs.pass.trim();
                                const l = leaders.find(x => (x.username.toLowerCase() === cleanUser || x.name === cleanUser) && x.password === cleanPass);
                                if (l) {
                                    setIdentity({ role: 'leader', ...l });
                                    setViewingBusId(l.busId);
                                    setView('dashboard');
                                } else alert("å¸³è™Ÿå¯†ç¢¼éŒ¯èª¤");
                            }, className: 'w-full bg-blue-600 py-3 rounded-lg font-bold active:scale-95' }, 'ç™»å…¥')
                        ),
                        e('button', { onClick: ()=>{
                             setViewingBusId('bus_A'); setIdentity({ role: 'member' }); setView('member_scan');
                        }, className: 'w-full bg-white text-slate-900 py-4 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg active:scale-95' },
                            e(Icon, { i: 'ğŸ“·' }), ' åœ˜å“¡æƒç¢¼æ¨¡æ“¬'
                        ),
                        e('div', { className: 'text-center mt-4' }, 
                            e('span', { onClick: ()=>setView('admin_login'), className: 'text-gray-500 text-xs underline cursor-pointer' }, 'ç®¡ç†å“¡å¾Œå°')
                        )
                    )
                )
            );

            if (view === 'admin_login') {
                return (
                    e('div', { className: 'min-h-screen bg-slate-800 flex items-center justify-center p-6' },
                        e('div', { className: 'bg-white p-8 rounded-2xl w-full max-w-sm text-gray-900 shadow-2xl' },
                            e('h2', { className: 'text-xl font-bold mb-4 text-center' }, 'ç®¡ç†è€…ç™»å…¥'),
                            e('div', { className: 'relative mb-6' },
                                e('input', { 
                                    type: showPassword ? "text" : "password", 
                                    value: inputs.adminPass, 
                                    onChange: e=>setInputs({...inputs, adminPass: e.target.value}), 
                                    className: 'w-full border-2 border-slate-300 p-4 rounded-xl text-lg focus:border-blue-500 outline-none', 
                                    placeholder: 'è«‹è¼¸å…¥ admin888', 
                                    autoCapitalize: 'off' 
                                }),
                                e('button', { onClick: ()=>setShowPassword(!showPassword), className: 'absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 p-2' }, 
                                    showPassword ? 'ğŸ‘ï¸' : 'ğŸ™ˆ'
                                )
                            ),
                            e('button', { onClick: ()=>{ if(inputs.adminPass.trim().toLowerCase() === 'admin888') setView('admin_panel'); else alert("å¯†ç¢¼éŒ¯èª¤"); }, className: 'w-full bg-slate-800 text-white py-4 rounded-xl font-bold text-lg active:scale-95 shadow-lg' }, 'ç™»å…¥'),
                            e('button', { onClick: ()=>setView('landing'), className: 'w-full mt-4 text-slate-400 py-2' }, 'å–æ¶ˆ')
                        )
                    )
                );
            }

            if (view === 'dashboard') {
                const bus = tours[viewingBusId] || { busName: 'Loading...', members: [], boardedIds: [] };
                const myGroupLeaders = leaders.filter(l => l.group === identity.group);
                const pending = bus.members.filter(m => !bus.boardedIds.includes(m.id));
                const boarded = bus.members.filter(m => bus.boardedIds.includes(m.id));
                const isMyBus = identity.busId === viewingBusId && identity.role === 'leader'; // ä¿®æ­£ï¼šåªæœ‰é ˜éšŠè§’è‰²æ‰å—é™æ–¼è‡ªå·±çš„è»Š

                return (
                    e('div', { className: 'flex flex-col h-screen bg-gray-100 text-gray-900' },
                        e('div', { className: 'bg-white p-3 shadow z-10 flex justify-between items-center' },
                            e('div', { className: 'flex items-center gap-2' },
                                e('button', { onClick: ()=>setView('landing'), className: 'border p-2 rounded text-xl' }, 'ğŸšª'),
                                e('div', null,
                                    e('div', { className: 'text-xs text-gray-500' }, identity.name),
                                    e('div', { className: 'font-bold text-xl' }, bus.busName)
                                )
                            ),
                            e('div', { className: 'flex gap-2' },
                                e('button', { onClick: ()=>setModal('qr'), className: 'bg-slate-800 text-white py-2 px-3 rounded flex gap-1' }, e(Icon, { i: 'ğŸ“±' })),
                                e('button', { onClick: ()=>setModal('add'), className: 'bg-blue-600 text-white py-2 px-3 rounded flex gap-1' }, e(Icon, { i: 'â•' })),
                                e('button', { onClick: ()=>setModal('reset'), className: 'bg-orange-100 text-orange-600 py-2 px-3 rounded text-xl' }, 'ğŸ”„')
                            )
                        ),

                        e('div', { className: 'grid grid-cols-3 text-center py-2 bg-white border-t border-gray-200 text-sm shadow-sm' },
                            e('div', null, 'æ‡‰åˆ° ', e('span', { className: 'block text-lg font-bold' }, bus.members.length)),
                            e('div', { className: 'text-green-600' }, 'å·²åˆ° ', e('span', { className: 'block text-lg font-bold' }, bus.boardedIds.length)),
                            e('div', { className: 'text-red-500' }, 'æœªåˆ° ', e('span', { className: 'block text-lg font-bold' }, pending.length))
                        ),

                        e('div', { className: 'flex-1 overflow-y-auto p-3' },
                            e('div', { className: 'mb-6' },
                                e('h3', { className: 'text-gray-500 font-bold mb-2 text-sm border-b pb-1' }, 'âš ï¸ æœªä¸Šè»Š (é»æ“Šæ“ä½œ)'),
                                e('div', { className: 'grid grid-cols-3 gap-2' },
                                    pending.map(m => (
                                        e('div', { 
                                            key: m.id, 
                                            onClick: ()=>{
                                                setSelectedMember(m); 
                                                setModal('member_action');
                                            }, 
                                            className: 'bg-yellow-50 border-2 border-yellow-300 rounded p-2 min-h-[70px] flex flex-col items-center justify-center text-center shadow-sm relative active:scale-95 cursor-pointer'
                                        },
                                            e('span', { className: 'font-bold text-lg leading-tight' }, m.name),
                                            m.phone && e('span', { className: 'text-[10px] text-blue-500 mt-1' }, 'ğŸ“')
                                        )
                                    )),
                                ),
                                pending.length === 0 && bus.members.length > 0 && e('div', { className: 'text-center py-8 text-gray-400' }, 'å…¨å“¡åˆ°é½Š ğŸ‰')
                            ),

                            boarded.length > 0 && (
                                e('div', null,
                                    e('h3', { className: 'text-green-600 font-bold mb-2 text-sm border-b pb-1' }, 'âœ… å·²ä¸Šè»Š'),
                                    e('div', { className: 'grid grid-cols-3 gap-2' },
                                        boarded.map(m => (
                                            e('div', { 
                                                key: m.id, 
                                                onClick: ()=>toggleBoarding(viewingBusId, m.id, false), 
                                                className: 'bg-green-600 text-white rounded p-2 min-h-[70px] flex flex-col items-center justify-center text-center shadow active:scale-95 cursor-pointer'
                                            },
                                                e('span', { className: 'font-bold text-lg' }, m.name)
                                            )
                                        ))
                                    )
                                )
                            )
                        ),

                        // Member Action Modal
                        modal === 'member_action' && selectedMember && (
                            e('div', { className: 'fixed inset-0 bg-black/80 z-50 flex flex-col items-center justify-center p-6 modal-enter', onClick: ()=>setModal(null) },
                                e('div', { className: 'bg-white w-full max-w-sm rounded-2xl p-6 text-center', onClick: e=>e.stopPropagation() },
                                    e('h3', { className: 'text-2xl font-bold mb-2' }, selectedMember.name),
                                    e('p', { className: 'text-gray-500 mb-6 text-sm' }, 'å°šæœªä¸Šè»Š'),
                                    selectedMember.phone ? (
                                        e('a', { href: `tel:${selectedMember.phone}`, className: 'block w-full bg-green-500 text-white py-4 rounded-xl font-bold text-xl mb-3 shadow-lg flex items-center justify-center gap-2 active:scale-95 no-underline' },
                                            e(Icon, { i: 'ğŸ“' }), ' æ’¥æ‰“é›»è©± ', e('span', { className: 'text-sm font-normal opacity-80' }, `(${selectedMember.phone})`)
                                        )
                                    ) : e('div', { className: 'bg-gray-100 text-gray-400 py-3 rounded-xl mb-3 text-sm' }, 'ç„¡é›»è©±è³‡æ–™'),
                                    e('button', { onClick: ()=>{ toggleBoarding(viewingBusId, selectedMember.id, true); setModal(null); }, className: 'w-full bg-blue-600 text-white py-3 rounded-xl font-bold text-lg mb-3 shadow active:scale-95' }, 'ç¢ºèªå ±åˆ° (ä¸Šè»Š)'),
                                    e('button', { onClick: ()=>{ 
                                        if (confirm("ç¢ºå®šè¦åˆªé™¤æ­¤äººå—ï¼Ÿ")) { 
                                            updateBusData(viewingBusId, {members: bus.members.filter(x=>x.id!==selectedMember.id)}); 
                                            setModal(null); 
                                        }
                                    }, className: 'w-full border border-red-200 text-red-500 py-3 rounded-xl font-bold text-sm active:bg-red-50' }, 'åˆªé™¤äººå“¡')
                                )
                            )
                        ),

                        // QR Modal
                        modal === 'qr' && (
                            e('div', { className: 'fixed inset-0 bg-black/90 z-50 flex flex-col items-center justify-center p-6', onClick: ()=>setModal(null) },
                                e('div', { className: 'bg-white p-6 rounded-2xl text-center w-full max-w-sm', onClick: e=>e.stopPropagation() },
                                    e('h3', { className: 'text-xl font-bold mb-2' }, bus.busName),
                                    e('img', { 
                                        src: `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(window.location.href)}`, 
                                        className: 'w-full h-auto border rounded mb-4',
                                        alt: 'åœ˜å“¡å ±åˆ° QR Code'
                                    }),
                                    e('p', { className: 'text-xs text-gray-500' }, 'è«‹åœ˜å“¡æƒææ­¤ç¢¼å ±åˆ°'),
                                    e('button', { onClick: ()=>setModal(null), className: 'mt-4 w-full bg-gray-100 py-3 rounded font-bold' }, 'é—œé–‰')
                                )
                            )
                        ),

                        // Add Modal
                        modal === 'add' && (
                            e('div', { className: 'fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4' },
                                e('div', { className: 'bg-white p-6 rounded-2xl w-full max-w-sm' },
                                    e('h3', { className: 'font-bold text-lg mb-2' }, 'åŒ¯å…¥åå–®'),
                                    e('p', { className: 'text-xs text-slate-500 mb-2' }, 'æ ¼å¼ï¼šå§“å é›»è©± (ä¾‹å¦‚ï¼šç‹å°æ˜ 0912345678)'),
                                    e('textarea', { 
                                        value: inputs.bulk, 
                                        onChange: e=>setInputs({...inputs, bulk: e.target.value}), 
                                        className: 'w-full border p-2 h-32 rounded mb-4 text-sm bg-gray-50', 
                                        placeholder: 'ç‹å°æ˜ 0912345678'
                                    }),
                                    e('div', { className: 'flex gap-2' },
                                        e('button', { onClick: handleImport, className: 'flex-1 bg-blue-600 text-white py-3 rounded font-bold' }, 'åŒ¯å…¥'),
                                        e('button', { onClick: ()=>setModal(null), className: 'flex-1 bg-gray-100 text-gray-600 py-3 rounded font-bold' }, 'å–æ¶ˆ')
                                    )
                                )
                            )
                        ),
                        
                        // Reset Modal
                        modal === 'reset' && (
                            e('div', { className: 'fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4' },
                                e('div', { className: 'bg-white p-6 rounded-2xl w-full max-w-sm' },
                                    e('h3', { className: 'font-bold text-lg text-orange-600 mb-4' }, 'é‡ç½®æœ¬è»Šç‹€æ…‹'),
                                    e('p', { className: 'text-sm text-gray-600 mb-4' }, 'å°‡æ‰€æœ‰åœ˜å“¡è¨­ç‚ºã€Œæœªä¸Šè»Šã€ç‹€æ…‹ã€‚'),
                                    e('button', { onClick: ()=>{ 
                                        if (confirm("ç¢ºèªé‡ç½®æ‰€æœ‰åœ˜å“¡çš„å ±åˆ°ç‹€æ…‹å—ï¼Ÿ")) {
                                            updateBusData(viewingBusId, {boardedIds:[]}); 
                                            setModal(null); 
                                        }
                                    }, className: 'w-full bg-orange-500 text-white py-3 rounded font-bold mb-2' }, 'ç¢ºèªé‡ç½® (å…¨éƒ¨æœªä¸Šè»Š)'),
                                    e('button', { onClick: ()=>setModal(null), className: 'w-full bg-gray-100 py-3 rounded font-bold' }, 'å–æ¶ˆ')
                                )
                            )
                        )
                    )
                );
            }

            if (view === 'member_scan') {
                return (
                    e('div', { className: 'min-h-screen bg-blue-600 flex flex-col items-center justify-center p-6 text-white' },
                        e('div', { className: 'bg-white text-gray-900 w-full max-w-sm rounded-3xl p-8 shadow-2xl text-center' },
                            e('h2', { className: 'text-2xl font-bold mb-2' }, 'åœ˜å“¡å ±åˆ°'),
                            e('p', { className: 'text-sm text-gray-500 mb-6' }, 'è«‹è¼¸å…¥æ‰‹æ©Ÿæœ« 3 ç¢¼'),
                            e('input', { 
                                value: inputs.memberPhone, 
                                onChange: e=>setInputs({...inputs, memberPhone: e.target.value}), 
                                className: 'w-full border-2 border-blue-100 bg-blue-50 text-center text-4xl font-bold p-4 rounded-xl mb-6 outline-none', 
                                maxLength: 3, 
                                type: 'tel', 
                                placeholder: '---'
                            }),
                            e('button', { onClick: handleMemberVerify, className: 'w-full bg-blue-600 text-white py-4 rounded-xl font-bold text-xl shadow-lg active:scale-95' }, 'ç¢ºèªå ±åˆ°'),
                            e('button', { onClick: ()=>setView('landing'), className: 'mt-4 text-gray-400 text-sm' }, 'å–æ¶ˆ')
                        )
                    )
                );
            }

            if (view === 'admin_panel') {
                return (
                    e('div', { className: 'min-h-screen bg-gray-100 p-4 text-gray-900' },
                        e('div', { className: 'bg-white p-6 rounded-2xl shadow-sm mb-4' },
                            e('h2', { className: 'text-2xl font-bold mb-6' }, 'ç³»çµ±è¨­å®š'),
                            e('div', { className: 'bg-gray-800 text-white p-4 rounded-xl mb-6' },
                                e('h3', { className: 'font-bold mb-2' }, 'â˜ï¸ é›²ç«¯è³‡æ–™åº«'),
                                !isCloud ? (
                                    e(React.Fragment, null,
                                        e('textarea', { 
                                            value: inputs.firebase, 
                                            onChange: e=>setInputs({...inputs, firebase: e.target.value}), 
                                            className: 'w-full bg-black text-green-400 text-xs p-2 rounded h-20 mb-2 font-mono', 
                                            placeholder: 'Firebase Config JSON'
                                        }),
                                        e('button', { onClick: saveFirebaseConfig, className: 'bg-blue-600 px-4 py-2 rounded text-sm font-bold' }, 'å•Ÿç”¨')
                                    )
                                ) : e('div', { className: 'text-green-400 font-bold' }, 'âœ… å·²é€£ç·š')
                            ),

                            // â˜… V68 æ‡¶äººé€£çµåˆ†äº«å€ â˜…
                            e('div', { className: 'bg-indigo-50 border-2 border-indigo-100 p-4 rounded-xl mb-6' },
                                e('h3', { className: 'font-bold text-indigo-700 mb-2' }, 'ğŸš€ åˆ†äº«ç³»çµ±é€£çµ'),
                                e('p', { className: 'text-xs text-indigo-500 mb-3' }, 'é€éæ­¤é€£çµï¼Œåœ˜å“¡èˆ‡é ˜éšŠæ‰“é–‹å¾Œå°‡', e('b', null, 'è‡ªå‹•å¥—ç”¨é›²ç«¯è¨­å®š'), 'ï¼Œç„¡éœ€æ‰‹å‹•è¼¸å…¥ã€‚'),
                                e('button', { onClick: generateMagicLink, className: 'w-full bg-indigo-600 text-white py-3 rounded-lg font-bold shadow-md active:scale-95' },
                                    'ğŸ“‹ è¤‡è£½ã€Œæ‡¶äººè¨­å®šã€é€£çµ'
                                )
                            ),

                            e('button', { onClick: ()=>setView('landing'), className: 'w-full border p-3 rounded' }, 'ç™»å‡º')
                        )
                    )
                );
            }

            return e('div', null, 'Loading...');
        }

        // --- æ¸²æŸ“æ‡‰ç”¨ç¨‹å¼ ---
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(e(App, null));
    </script>
	
<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyDnEygFfGin-UyqsPMHHlRToVcbLJZi0ig",
    authDomain: "tour-leader-system.firebaseapp.com",
    projectId: "tour-leader-system",
    storageBucket: "tour-leader-system.firebasestorage.app",
    messagingSenderId: "556520250588",
    appId: "1:556520250588:web:b60870c4281aa04bb4e819"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
</script>
	
	
</body>
</html>